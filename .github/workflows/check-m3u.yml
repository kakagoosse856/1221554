name: M3U Playlist Auto-Checker

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§Øª (ØªØ¹Ø¯Ù„ ÙƒÙ…Ø§ ØªØ±ÙŠØ¯)
    - cron: '0 */3 * * *'
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub
  workflow_dispatch:
    inputs:
      custom_urls:
        description: 'Custom M3U URLs (comma separated)'
        required: false
        default: ''
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙØ§Øª Ù…Ù‡Ù…Ø©
  push:
    paths:
      - '.github/workflows/check-m3u.yml'
      - 'scripts/checker.py'
      - 'playlists.json'

# Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
permissions:
  contents: write
  actions: read
  checks: write

jobs:
  check-playlists:
    runs-on: ubuntu-latest
    
    outputs:
      status: ${{ steps.check.outputs.STATUS }}
      valid_count: ${{ steps.check.outputs.VALID_PLAYLISTS }}
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        pip install requests
        
    - name: ðŸ” Run M3U Checker
      id: check
      env:
        CUSTOM_URLS: ${{ inputs.custom_urls }}
      run: |
        echo "Starting M3U playlist check..."
        echo "Custom URLs: $CUSTOM_URLS"
        
        if [ -n "$CUSTOM_URLS" ]; then
          python scripts/checker.py "$CUSTOM_URLS"
        else
          python scripts/checker.py
        fi
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ù…Ù„Ù
        if [ -f "check_results.json" ]; then
          RESULTS=$(cat check_results.json)
          echo "results=$RESULTS" >> $GITHUB_ENV
        fi
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if [ -f "merged_channels.m3u" ]; then
          CHANNELS_COUNT=$(grep -c "^http" merged_channels.m3u || echo "0")
          echo "channels_count=$CHANNELS_COUNT" >> $GITHUB_ENV
        fi
    
    - name: ðŸ“Š Show Results Summary
      if: always()
      run: |
        echo "=== CHECK RESULTS ==="
        if [ -f "check_results.json" ]; then
          python -c "
          import json
          with open('check_results.json') as f:
              data = json.load(f)
          
          print(f'Success: {data[\"success\"]}')
          print(f'Timestamp: {data[\"timestamp\"]}')
          print(f'Valid URLs: {data[\"summary\"][\"valid_urls\"]}/{data[\"summary\"][\"total_urls_checked\"]}')
          
          if data[\"details\"]:
              print('\nDetails:')
              for item in data['details']:
                  status = 'âœ…' if item['status'] == 'valid' else 'âŒ'
                  print(f'{status} {item[\"url\"][:60]}...')
          "
        else
          echo "No results file found"
        echo "====================="
    
    - name: ðŸ’¾ Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: m3u-results
        path: |
          merged_channels.m3u
          check_results.json
        retention-days: 7
    
    - name: ðŸ“¤ Commit Changes
      if: success()
      id: commit
      run: |
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --quiet HEAD merged_channels.m3u check_results.json; then
          echo "No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected, committing..."
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add merged_channels.m3u
          git add check_results.json
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M")
          COMMIT_MESSAGE="ðŸ“¡ Update M3U playlists - $TIMESTAMP"
          
          # Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          if [ -f "check_results.json" ]; then
            VALID_COUNT=$(python -c "import json; d=json.load(open('check_results.json')); print(d['summary']['valid_urls'])" 2>/dev/null || echo "?")
            TOTAL_COUNT=$(python -c "import json; d=json.load(open('check_results.json')); print(d['summary']['total_urls_checked'])" 2>/dev/null || echo "?")
            CHANNELS_COUNT=$(grep -c "^http" merged_channels.m3u 2>/dev/null || echo "?")
            
            COMMIT_MESSAGE="$COMMIT_MESSAGE
            âœ… Valid: $VALID_COUNT/$TOTAL_COUNT
            ðŸ“º Channels: $CHANNELS_COUNT"
          fi
          
          git commit -m "$COMMIT_MESSAGE"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: ðŸš€ Push Changes
      if: steps.commit.outputs.changes == 'true'
      run: |
        echo "Pushing changes to repository..."
        git push origin HEAD:${{ github.ref_name }}
        
    - name: ðŸ“¢ Create Summary
      if: always()
      run: |
        echo "## M3U Playlist Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "check_results.json" ]; then
          python -c "
          import json, datetime
          with open('check_results.json') as f:
              data = json.load(f)
          
          # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
          ts = data['timestamp']
          try:
              dt = datetime.datetime.fromisoformat(ts.replace('Z', '+00:00'))
              time_str = dt.strftime('%Y-%m-%d %H:%M:%S UTC')
          except:
              time_str = ts
          
          print(f'**Check Time:** {time_str}')
          print(f'**Status:** {"âœ… Success" if data[\"success\"] else "âŒ Failed"}')
          print(f'**Valid Playlists:** {data[\"summary\"][\"valid_urls\"]}/{data[\"summary\"][\"total_urls_checked\"]}')
          print('')
          print('### Playlist Details:')
          print('| Status | URL | Channels |')
          print('|--------|-----|----------|')
          
          for item in data['details']:
              url_short = item['url'][:50] + ('...' if len(item['url']) > 50 else '')
              if item['status'] == 'valid':
                  status_icon = 'âœ…'
                  channels = item.get('channels_count', 'N/A')
              else:
                  status_icon = 'âŒ'
                  channels = '0'
              
              print(f'| {status_icon} | `{url_short}` | {channels} |')
          " >> $GITHUB_STEP_SUMMARY
        else:
          echo "âŒ No results file generated" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Generated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- **`merged_channels.m3u`**: Combined playlist" >> $GITHUB_STEP_SUMMARY
        echo "- **`check_results.json`**: Detailed results" >> $GITHUB_STEP_SUMMARY
