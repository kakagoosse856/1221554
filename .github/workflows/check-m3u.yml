name: M3U Playlist Auto-Checker

on:
  # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
  schedule:
    - cron: '0 */6 * * *'
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† GitHub
  workflow_dispatch:
    inputs:
      custom_url:
        description: 'Custom M3U URL (optional)'
        required: false
        default: ''
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙØ§Øª
  push:
    paths:
      - '.github/workflows/check-m3u.yml'
      - 'scripts/checker.py'
      - 'playlists.json'

# Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
permissions:
  contents: write

jobs:
  check-playlists:
    runs-on: ubuntu-latest
    
    steps:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: Install dependencies
        run: |
          pip install requests
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ
      - name: Run M3U Checker
        id: checker
        run: |
          echo "ðŸ” Checking M3U playlists..."
          python scripts/checker.py
          echo "âœ… Check completed!"
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 5: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙƒÙ…Ù„Ù
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: m3u-playlist-results
          path: |
            merged_channels.m3u
            check_results.json
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Commit and push changes
        if: success()
        run: |
          # ØªÙƒÙˆÙŠÙ† Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
          git add merged_channels.m3u check_results.json || echo "No files to add"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
          if ! git diff --cached --quiet; then
            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            if [ -f "check_results.json" ]; then
              STATS=$(python3 -c "
import json
try:
    with open('check_results.json', 'r') as f:
        data = json.load(f)
    summary = data['summary']
    print(f'{summary[\"valid_urls\"]}/{summary[\"total_urls\"]} playlists, {summary[\"unique_channels\"]} channels')
except Exception as e:
    print('Updated playlist')
")
            else
              STATS="Updated playlist"
            fi
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù€ commit
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M")
            COMMIT_MSG="ðŸ“¡ Update M3U playlist ($STATS) - $TIMESTAMP"
            
            # ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ commit Ùˆ push
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "ðŸ“­ No changes to commit"
          fi
      
      # Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š M3U Playlist Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "check_results.json" ]; then
            python3 << 'EOF'
import json
from datetime import datetime

try:
    with open('check_results.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    ts = data['timestamp']
    try:
        dt = datetime.fromisoformat(ts.replace('Z', '+00:00'))
        time_str = dt.strftime('%Y-%m-%d %H:%M:%S')
    except:
        time_str = ts
    
    print(f"**Check Time:** {time_str}")
    
    summary = data['summary']
    print(f"**Status:** {'âœ… Success' if summary['valid_urls'] > 0 else 'âŒ Failed'}")
    print(f"**Valid Playlists:** {summary['valid_urls']}/{summary['total_urls']}")
    print(f"**Unique Channels:** {summary['unique_channels']}")
    
    print("")
    print("### ðŸ“‹ Playlist Details:")
    print("| Status | URL | Channels |")
    print("|--------|-----|----------|")
    
    for result in data['results']:
        url = result['url']
        if len(url) > 50:
            url = url[:47] + "..."
        
        if result['status'] == 'valid':
            status = "âœ…"
            channels = result['channels']
        else:
            status = "âŒ"
            channels = 0
        
        print(f"| {status} | `{url}` | {channels} |")
        
except Exception as e:
    print(f"âŒ Error: {str(e)}")
EOF
          else
            echo "âŒ No results file found"
          fi >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- **`merged_channels.m3u`** - Combined M3U playlist" >> $GITHUB_STEP_SUMMARY
          echo "- **`check_results.json`** - Detailed check results" >> $GITHUB_STEP_SUMMARY
