name: M3U Playlist Checker
on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª (ØªØ¹Ø¯Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
    - cron: '0 */6 * * *'
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† GitHub
  workflow_dispatch:
    inputs:
      playlist_urls:
        description: 'M3U URLs (separate by commas)'
        required: false
        default: 'https://raw.githubusercontent.com/kakagoosse856/1221554/2a5d587b525902b4a5fa4e13c977136839247f43/SSULTAN.m3u'
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
  push:
    paths:
      - '.github/workflows/check-m3u.yml'
      - 'scripts/checker.py'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests
        pip install python-dateutil
    
    - name: Run M3U Checker
      id: checker
      env:
        PLAYLIST_URLS: ${{ github.event.inputs.playlist_urls || 'https://raw.githubusercontent.com/kakagoosse856/1221554/2a5d587b525902b4a5fa4e13c977136839247f43/SSULTAN.m3u' }}
      run: |
        echo "ğŸ” Checking M3U playlists..."
        python scripts/checker.py "$PLAYLIST_URLS"
        
        # Ø­ÙØ¸ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ùƒ output
        if [ -f "check_results.json" ]; then
          RESULTS=$(cat check_results.json)
          echo "results=$RESULTS" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: m3u-check-results
        path: |
          merged_channels.m3u
          check_results.json
          logs/
    
    - name: Commit and Push if Changed
      id: commit
      if: success()
      run: |
        if git diff --quiet HEAD -- merged_channels.m3u; then
          echo "No changes detected"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected, committing..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add merged_channels.m3u
          git add check_results.json
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          git commit -m "ğŸ“¡ Updated M3U playlists - $TIMESTAMP" -m "Auto-update by GitHub Actions"
          
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Push Changes
      if: steps.commit.outputs.changed == 'true'
      run: |
        git push origin HEAD:${{ github.ref_name }}
    
    - name: Send Notification
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const results = JSON.parse(process.env.RESULTS || '{}');
          const changed = '${{ steps.commit.outputs.changed }}' === 'true';
          
          let message = 'ğŸ¯ **M3U Playlist Check Complete**\n\n';
          
          if (results.stats) {
            message += `**Statistics:**\n`;
            message += `â€¢ Total URLs checked: ${results.stats.total_urls || 0}\n`;
            message += `â€¢ Working URLs: ${results.stats.working_urls || 0}\n`;
            message += `â€¢ Total channels: ${results.stats.total_channels || 0}\n`;
            message += `â€¢ Last update: ${results.timestamp || 'N/A'}\n\n`;
          }
          
          if (changed) {
            message += 'âœ… **Changes were committed to repository**\n';
            message += 'ğŸ“ File: `merged_channels.m3u` updated';
          } else {
            message += 'ğŸ“­ No changes detected';
          }
          
          // Ø¥Ù†Ø´Ø§Ø¡ comment Ø¹Ù„Ù‰ PR Ø£Ùˆ issue (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… GitHub Actions notifications
          
          console.log(message);
          
          // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Discord/Slack/Telegram Ù‡Ù†Ø§
      env:
        RESULTS: ${{ steps.checker.outputs.results }}
